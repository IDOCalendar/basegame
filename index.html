<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base Runner: Double Jump</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; }
        canvas { display: block; }
        #ui { position: absolute; top: 10px; left: 10px; font-family: sans-serif; }
    </style>
</head>
<body>

    <div id="ui" class="pointer-events-none w-full pr-5">
        <h1 class="text-white font-bold text-2xl drop-shadow-md">base runner v3</h1>
        <p class="text-white text-sm">space x2 = double jump | f = shoot</p>
        
        <div class="mt-2 flex gap-4">
            <div class="text-4xl font-black text-yellow-300 drop-shadow-lg">
                score: <span id="scoreVal">0</span>
            </div>
            <div class="text-xl font-bold text-white/80 mt-2">
                best: <span id="highScoreVal">0</span>
            </div>
        </div>
        
        <div id="gameOverScreen" class="hidden fixed inset-0 flex items-center justify-center bg-black/50 pointer-events-auto">
            <div class="bg-white p-6 rounded-2xl text-center shadow-2xl">
                <h2 class="text-2xl font-bold mb-4 text-red-500">game over!</h2>
                <p class="text-gray-500 mb-4">score: <span id="finalScore">0</span></p>
                <button onclick="resetGame()" class="bg-blue-600 text-white px-6 py-2 rounded-full font-bold hover:bg-blue-500 transition-transform active:scale-95">try again</button>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('scoreVal');
        const highScoreEl = document.getElementById('highScoreVal');
        const finalScoreEl = document.getElementById('finalScore');
        const gameOverScreen = document.getElementById('gameOverScreen');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // --- НАСТРОЙКИ ---
        let gameSpeed = 6;
        const jumpForce = -15;    // сила одного прыжка
        const gravityVal = 0.7;   // гравитация (чуть легче для двойного прыжка)
        const maxJumps = 2;       // сколько прыжков можно сделать (2 = двойной)
        // -----------------

        let score = 0;
        let highScore = localStorage.getItem('baseRunnerHighScore') || 0;
        highScoreEl.innerText = highScore;

        let gameRunning = true;
        let frame = 0;

        const player = {
            x: 50,
            y: 0,
            width: 50,
            height: 50,
            dy: 0,
            jumpCount: 0, // счетчик прыжков
            grounded: false
        };

        let obstacles = [];
        let items = [];
        let bullets = [];

        const COLORS = {
            sky: '#87CEEB',
            ground: '#2D1B4E',
            player: '#D946EF',
            obstacle: '#F59E0B',
            item: '#E9D5FF',
            bullet: '#EF4444'
        };

        let groundHeight = 100;
        
        function updateCanvasSize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (player.grounded) {
                player.y = canvas.height - groundHeight - player.height;
            }
        }
        window.addEventListener('resize', updateCanvasSize);

        // управление
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') jump();
            if (e.code === 'KeyF') shoot();
        });
        window.addEventListener('touchstart', (e) => {
            if (e.touches[0].clientY < window.innerHeight / 2) jump();
            else shoot();
        });
        window.addEventListener('mousedown', () => shoot());

        function jump() {
            if (!gameRunning) return;
            
            // логика двойного прыжка
            // прыгаем, если стоим на земле ИЛИ если сделали меньше максимума прыжков
            if (player.grounded || player.jumpCount < maxJumps) {
                player.dy = jumpForce;
                player.grounded = false;
                player.jumpCount++; // засчитываем прыжок
                
                // визуальный эффект (можно добавить частицы потом)
            }
        }

        function shoot() {
            if (!gameRunning) return;
            bullets.push({
                x: player.x + player.width,
                y: player.y + player.height / 2,
                width: 20,
                height: 5,
                speed: 12
            });
        }

        function spawnObstacle() {
            // рандомайзер типа препятствия
            const type = Math.random();
            let obsW, obsH, obsY;

            if (type < 0.33) {
                // 1. классический вертикальный (высокий)
                obsW = 40;
                obsH = 80; 
                obsY = canvas.height - groundHeight - obsH;
            } else if (type < 0.66) {
                // 2. горизонтальный (длинный и низкий) - требует длинного прыжка
                obsW = 120; // широкий!
                obsH = 40;
                obsY = canvas.height - groundHeight - obsH;
            } else {
                // 3. воздушный блок (надо проскочить под ним или перепрыгнуть)
                obsW = 60;
                obsH = 40;
                obsY = canvas.height - groundHeight - 110; // висит в воздухе
            }

            obstacles.push({
                x: canvas.width,
                y: obsY,
                width: obsW,
                height: obsH,
                color: COLORS.obstacle
            });
        }

        function spawnItem() {
            let minH = 10;
            let maxH = 200; // теперь предметы могут быть выше (под двойной прыжок)
            let randomH = Math.floor(Math.random() * (maxH - minH + 1)) + minH;

            items.push({
                x: canvas.width,
                y: canvas.height - groundHeight - randomH - 30,
                width: 25,
                height: 35,
                color: COLORS.item
            });
        }

        function checkHighScore() {
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('baseRunnerHighScore', highScore);
                highScoreEl.innerText = highScore;
            }
        }

        function resetGame() {
            obstacles = [];
            items = [];
            bullets = [];
            score = 0;
            scoreEl.innerText = score;
            gameRunning = true;
            gameSpeed = 6;
            player.dy = 0;
            player.jumpCount = 0;
            player.y = canvas.height - groundHeight - player.height;
            gameOverScreen.classList.add('hidden');
            animate();
        }

        function rectIntersect(r1, r2) {
            return !(r2.x > r1.x + r1.width || 
                     r2.x + r2.width < r1.x || 
                     r2.y > r1.y + r1.height || 
                     r2.y + r2.height < r1.y);
        }

        function animate() {
            if (!gameRunning) return;

            requestAnimationFrame(animate);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            frame++;

            // фон
            ctx.fillStyle = COLORS.sky;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = COLORS.ground;
            ctx.fillRect(0, canvas.height - groundHeight, canvas.width, groundHeight);

            // физика игрока
            player.dy += player.gravity; // добавляем гравитацию
            player.y += player.dy;       // двигаем игрока

            // проверка столкновения с полом
            if (player.y + player.height > canvas.height - groundHeight) {
                player.y = canvas.height - groundHeight - player.height;
                player.dy = 0;
                player.grounded = true;
                player.jumpCount = 0; // сбрасываем счетчик прыжков при касании земли
            } else {
                player.grounded = false;
            }

            // отрисовка игрока
            ctx.fillStyle = COLORS.player;
            ctx.fillRect(player.x, player.y, player.width, player.height);
            // лицо
            ctx.fillStyle = 'white';
            ctx.fillRect(player.x + 30, player.y + 10, 10, 10);
            
            // если есть второй прыжок в запасе, рисуем индикатор (маленькую точку над головой)
            if (player.jumpCount < maxJumps) {
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(player.x + 25, player.y - 10, 4, 0, Math.PI*2);
                ctx.fill();
            }

            // ПУЛИ
            for (let i
